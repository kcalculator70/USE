<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroLink - Secure Call</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #212529;
            --text-main: #e0e5ec;
            --accent: #00ff88;
            --danger: #ff4757;
            --shadow-light: #2c3238;
            --shadow-dark: #16191c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
        }

        /* Neumorphism Styles */
        .neu-flat {
            background: var(--bg-color);
            box-shadow: 7px 7px 14px var(--shadow-dark), 
                        -7px -7px 14px var(--shadow-light);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .neu-input {
            width: 100%;
            background: var(--bg-color);
            border: none;
            outline: none;
            color: var(--text-main);
            padding: 15px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), 
                        inset -4px -4px 8px var(--shadow-light);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .neu-input:focus {
            box-shadow: inset 6px 6px 12px var(--shadow-dark), 
                        inset -6px -6px 12px var(--shadow-light);
            color: var(--accent);
        }

        .neu-btn {
            background: linear-gradient(145deg, #23282c, #1e2125);
            box-shadow: 6px 6px 12px var(--shadow-dark), 
                        -6px -6px 12px var(--shadow-light);
            color: #8892b0;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .neu-btn:active {
            box-shadow: inset 6px 6px 12px var(--shadow-dark), 
                        inset -6px -6px 12px var(--shadow-light);
            transform: scale(0.95);
        }

        .neu-btn.active-state {
            box-shadow: inset 6px 6px 12px var(--shadow-dark), 
                        inset -6px -6px 12px var(--shadow-light);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        /* Video Styles */
        video {
            object-fit: cover;
            transform: scaleX(-1);
            width: 100%;
            height: 100%;
        }

        .video-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 25px;
            background: #1a1d21;
            box-shadow: inset 5px 5px 10px #121417, 
                        inset -5px -5px 10px #22262b;
        }

        /* Modal Overlay */
        .modal-overlay {
            background: rgba(22, 25, 28, 0.95);
            backdrop-filter: blur(5px);
        }

        /* Animations */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }
        .animate-ring { animation: pulse-ring 2s infinite; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <!-- Auth Section -->
    <div id="authSection" class="w-full max-w-sm neu-flat p-8 flex flex-col gap-6">
        <div class="text-center">
            <h1 class="text-3xl font-bold tracking-widest text-slate-300">NEURO<span style="color:var(--accent)">LINK</span></h1>
            <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest">Secure Video Channel</p>
        </div>
        
        <div class="flex flex-col gap-4">
            <input type="email" id="emailInput" class="neu-input" placeholder="Codename (Email)">
            <input type="password" id="passInput" class="neu-input" placeholder="Access Key (Password)">
        </div>

        <div class="flex gap-4">
            <button id="loginBtn" class="neu-btn flex-1 py-3 rounded-xl font-bold tracking-wider hover:text-white">LOGIN</button>
            <button id="registerBtn" class="neu-btn flex-1 py-3 rounded-xl font-bold tracking-wider hover:text-white">INIT</button>
        </div>
        <p id="msgDisplay" class="text-center text-xs text-red-400 h-4"></p>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="hidden w-full h-full max-w-md flex flex-col gap-4 relative">
        
        <!-- Header -->
        <div class="neu-flat p-4 flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#00ff88]"></div>
                <div>
                    <p class="text-[10px] text-slate-500 uppercase tracking-wider">Secure ID</p>
                    <p id="myId" class="text-xs font-mono text-slate-300 truncate w-32 cursor-pointer hover:text-white" title="Copy ID">Loading...</p>
                </div>
            </div>
            <button id="logoutBtn" class="neu-btn w-10 h-10 rounded-full flex items-center justify-center text-red-400"><i class="fas fa-power-off"></i></button>
        </div>

        <!-- Video Area -->
        <div class="flex-1 video-wrapper relative">
            <video id="remoteVideo" autoplay playsinline></video>
            
            <div class="absolute bottom-4 right-4 w-28 h-40 neu-flat overflow-hidden border-2 border-slate-700 shadow-2xl z-10">
                <video id="localVideo" autoplay playsinline muted></video>
            </div>

            <!-- Waiting Message -->
            <div id="waitingMsg" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 hidden">
                <div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-green-400 tracking-widest text-sm">CONNECTING...</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="neu-flat p-5 flex flex-col gap-4 z-20">
            <div class="flex gap-3">
                <input type="text" id="targetInput" class="neu-input font-mono text-center tracking-wider" placeholder="TARGET ID">
            </div>

            <div class="flex justify-between items-center px-4">
                <button id="camToggle" class="neu-btn w-12 h-12 rounded-full flex items-center justify-center text-xl active-state"><i class="fas fa-video"></i></button>
                
                <button id="callBtn" class="neu-btn w-16 h-16 rounded-full flex items-center justify-center text-2xl text-green-500 shadow-[0_0_15px_rgba(0,255,136,0.2)] hover:text-green-400 hover:scale-105 transition"><i class="fas fa-phone"></i></button>
                <button id="hangupBtn" class="hidden neu-btn w-16 h-16 rounded-full flex items-center justify-center text-2xl text-red-500 shadow-[0_0_15px_rgba(255,71,87,0.2)]"><i class="fas fa-phone-slash"></i></button>

                <button id="micToggle" class="neu-btn w-12 h-12 rounded-full flex items-center justify-center text-xl active-state"><i class="fas fa-microphone"></i></button>
            </div>
        </div>

        <!-- Incoming Call Modal (Popup) -->
        <div id="incomingModal" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
            <div class="neu-flat p-8 w-full max-w-xs text-center border border-green-500/30">
                <div class="w-20 h-20 bg-slate-800 rounded-full mx-auto mb-4 flex items-center justify-center animate-ring">
                    <i class="fas fa-phone-volume text-3xl text-green-400"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-1">INCOMING CALL</h3>
                <p id="callerIdDisplay" class="text-xs text-slate-400 mb-8 font-mono break-all">ID: Checking...</p>
                
                <div class="flex justify-center gap-6">
                    <button id="rejectBtn" class="w-14 h-14 rounded-full bg-red-600 hover:bg-red-700 text-white shadow-lg flex items-center justify-center transition hover:scale-110">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <button id="answerBtn" class="w-14 h-14 rounded-full bg-green-600 hover:bg-green-500 text-white shadow-[0_0_20px_rgba(34,197,94,0.6)] flex items-center justify-center transition hover:scale-110">
                        <i class="fas fa-check text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, child, get, remove, onChildAdded, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBy5AGDGQFZqbL83fKQfLViX_pyOu6AJ38",
            authDomain: "phone-f605e.firebaseapp.com",
            databaseURL: "https://phone-f605e-default-rtdb.firebaseio.com",
            projectId: "phone-f605e",
            storageBucket: "phone-f605e.firebasestorage.app",
            messagingSenderId: "902490805880",
            appId: "1:902490805880:web:3a2f31542674bc508e3f8d",
            measurementId: "G-LM88X7BV39"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // UI Elements
        const views = { auth: document.getElementById('authSection'), app: document.getElementById('appSection') };
        const inputs = { email: document.getElementById('emailInput'), pass: document.getElementById('passInput'), target: document.getElementById('targetInput') };
        const videos = { local: document.getElementById('localVideo'), remote: document.getElementById('remoteVideo') };
        const modals = { incoming: document.getElementById('incomingModal'), waiting: document.getElementById('waitingMsg') };
        
        let localStream, remoteStream, pc;
        let myUid, callId;
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- Auth & State ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = user.uid;
                views.auth.classList.add('hidden');
                views.app.classList.remove('hidden');
                document.getElementById('myId').textContent = myUid;
                listenForIncomingCalls();
            } else {
                views.auth.classList.remove('hidden');
                views.app.classList.add('hidden');
                modals.incoming.classList.add('hidden');
            }
        });

        document.getElementById('loginBtn').onclick = () => authHandler(signInWithEmailAndPassword);
        document.getElementById('registerBtn').onclick = () => authHandler(createUserWithEmailAndPassword);
        document.getElementById('logoutBtn').onclick = () => signOut(auth);
        document.getElementById('myId').onclick = () => { navigator.clipboard.writeText(myUid); alert("ID Copied!"); };

        async function authHandler(method) {
            try { await method(auth, inputs.email.value, inputs.pass.value); } 
            catch (e) { document.getElementById('msgDisplay').textContent = e.message; }
        }

        // --- WebRTC Core ---
        async function initMedia() {
            if (localStream) return;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videos.local.srcObject = localStream;
                remoteStream = new MediaStream();
                videos.remote.srcObject = remoteStream;
            } catch (e) { alert("Camera/Mic permission needed!"); }
        }

        async function createPC() {
            pc = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            pc.ontrack = e => e.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
            pc.onicecandidate = e => {
                if (e.candidate && callId) {
                    const path = `calls/${callId}/${pc.localDescription.type === 'offer' ? 'callerCandidates' : 'calleeCandidates'}`;
                    push(ref(db, path), e.candidate.toJSON());
                }
            };
            return pc;
        }

        // --- Caller Logic ---
        document.getElementById('callBtn').onclick = async () => {
            const targetId = inputs.target.value.trim();
            if (!targetId || targetId === myUid) return alert("Invalid Target ID");

            await initMedia();
            callId = myUid < targetId ? myUid + targetId : targetId + myUid;
            pc = await createPC();

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Set Call Data
            await set(ref(db, `calls/${callId}`), {
                caller: myUid,
                receiver: targetId,
                offer: { type: offer.type, sdp: offer.sdp },
                status: 'calling'
            });

            // Send Notification
            await set(ref(db, `notifications/${targetId}`), {
                caller: myUid,
                callId: callId
            });

            toggleCallUI(true);
            modals.waiting.classList.remove('hidden');

            // Listen for Answer
            onValue(ref(db, `calls/${callId}`), (snap) => {
                const data = snap.val();
                if (!data) return;
                
                if (data.answer && !pc.currentRemoteDescription) {
                    pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    modals.waiting.classList.add('hidden');
                }
                if (data.status === 'ended') endCall();
            });

            onChildAdded(ref(db, `calls/${callId}/calleeCandidates`), s => pc?.addIceCandidate(new RTCIceCandidate(s.val())));
        };

        // --- Receiver Logic (Manual Answer) ---
        function listenForIncomingCalls() {
            onValue(ref(db, `notifications/${myUid}`), (snap) => {
                const data = snap.val();
                if (data && data.callId) {
                    callId = data.callId;
                    document.getElementById('callerIdDisplay').textContent = data.caller;
                    modals.incoming.classList.remove('hidden');
                } else {
                    modals.incoming.classList.add('hidden');
                }
            });
        }

        // Answer Button
        document.getElementById('answerBtn').onclick = async () => {
            modals.incoming.classList.add('hidden');
            await initMedia();
            pc = await createPC();
            toggleCallUI(true);

            // Get Offer & Create Answer
            const data = (await get(ref(db, `calls/${callId}`))).val();
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            await update(ref(db, `calls/${callId}`), {
                answer: { type: answer.type, sdp: answer.sdp },
                status: 'connected'
            });

            // Cleanup Notification
            remove(ref(db, `notifications/${myUid}`));

            onChildAdded(ref(db, `calls/${callId}/callerCandidates`), s => pc?.addIceCandidate(new RTCIceCandidate(s.val())));
            onValue(ref(db, `calls/${callId}/status`), s => { if(s.val() === 'ended') endCall(); });
        };

        // Reject Button
        document.getElementById('rejectBtn').onclick = () => {
            modals.incoming.classList.add('hidden');
            remove(ref(db, `notifications/${myUid}`));
            if(callId) update(ref(db, `calls/${callId}`), { status: 'ended' });
        };

        // --- Cleanup & Helpers ---
        document.getElementById('hangupBtn').onclick = () => {
            if(callId) update(ref(db, `calls/${callId}`), { status: 'ended' });
            endCall();
        };

        function endCall() {
            pc?.close();
            pc = null;
            toggleCallUI(false);
            videos.remote.srcObject = null;
            modals.waiting.classList.add('hidden');
            callId = null;
            // Optional: Remove notification if I was caller
            const target = inputs.target.value.trim();
            if(target) remove(ref(db, `notifications/${target}`));
        }

        function toggleCallUI(inCall) {
            const btns = { call: document.getElementById('callBtn'), hang: document.getElementById('hangupBtn') };
            btns.call.classList.toggle('hidden', inCall);
            btns.hang.classList.toggle('hidden', !inCall);
        }

        document.getElementById('micToggle').onclick = (e) => {
            localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
            e.currentTarget.classList.toggle('active-state');
        };
        document.getElementById('camToggle').onclick = (e) => {
            localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled;
            e.currentTarget.classList.toggle('active-state');
        };
    </script>
</body>
</html>